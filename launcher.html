<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="./styles.css" />
    <script
      src="https://unpkg.com/@babel/standalone@7.25.6/babel.min.js"
      integrity="sha256-aS0B0wnsaDByLfE16h4MDCP1fQFccysd1YWOcV+gbBo="
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      import React, {
        useState,
        useEffect,
        useRef,
        useCallback,
      } from 'https://esm.sh/react@18?dev';
      import { createRoot } from 'https://esm.sh/react-dom@18/client?dev';
      import * as zebar from 'https://esm.sh/zebar@3.0';
      import { getCurrentWindow } from 'https://esm.sh/@tauri-apps/api@2.0.2/window';
      import { LogicalSize } from 'https://esm.sh/@tauri-apps/api@2.0.2/dpi';

      const tauriWindow = getCurrentWindow();

      async function resizeWindow(width, height) {
        try {
          await tauriWindow.setSize(new LogicalSize(width, height));
        } catch (err) {
          console.error('Resize failed:', err);
        }
      }

      createRoot(document.getElementById('root')).render(<App />);

      function applyTheme(theme) {
        const root = document.documentElement;
        const mapping = {
          background: '--bg',
          foreground: '--fg',
          accent: '--accent',
          hover: '--hover',
          active: '--active',
          border: '--border',
        };
        for (const [key, cssVar] of Object.entries(mapping)) {
          if (theme[key]) {
            root.style.setProperty(cssVar, theme[key]);
          }
        }
      }

      function App() {
        const [apps, setApps] = useState([]);
        const [mode, setMode] = useState('floating');
        const [isOpen, setIsOpen] = useState(false);
        const dropdownRef = useRef(null);

        // Load config.json on mount.
        useEffect(() => {
          fetch('./config.json')
            .then(res => res.json())
            .then(config => {
              if (config.apps) setApps(config.apps);
              if (config.mode) {
                setMode(config.mode);
                document.documentElement.dataset.mode = config.mode;
              }
              if (config.theme) applyTheme(config.theme);
            })
            .catch(err =>
              console.error('Failed to load config.json:', err),
            );
        }, []);

        // Resize window: button-sized when closed, full when open.
        useEffect(() => {
          if (mode !== 'embedded') return;
          if (isOpen) {
            resizeWindow(170, 240);
          } else {
            resizeWindow(48, 40);
          }
        }, [isOpen, mode]);

        // Close on Escape key.
        useEffect(() => {
          function handleKey(e) {
            if (e.key === 'Escape') setIsOpen(false);
          }
          document.addEventListener('keydown', handleKey);
          return () => document.removeEventListener('keydown', handleKey);
        }, []);

        // Close on click outside.
        useEffect(() => {
          function handleClickOutside(e) {
            if (
              dropdownRef.current &&
              !dropdownRef.current.contains(e.target)
            ) {
              setIsOpen(false);
            }
          }
          if (isOpen) {
            document.addEventListener('mousedown', handleClickOutside);
            return () =>
              document.removeEventListener(
                'mousedown',
                handleClickOutside,
              );
          }
        }, [isOpen]);

        const launchApp = useCallback(async (command) => {
          try {
            await zebar.shellExec('cmd', ['/c', 'start', command]);
          } catch (err) {
            console.error('Failed to launch:', command, err);
          }
          setIsOpen(false);
        }, []);

        return (
          <div
            className={`launcher ${mode === 'embedded' ? 'embedded' : ''}`}
            ref={dropdownRef}
          >
            <button
              className={`launcher-btn ${isOpen ? 'active' : ''}`}
              onClick={() => setIsOpen(prev => !prev)}
              title="App Launcher"
            >
              <i className="nf nf-md-apps"></i>
            </button>

            {isOpen && (
              <div className="dropdown">
                {apps.map((app, i) => (
                  <button
                    key={i}
                    className="app-item"
                    onClick={() => launchApp(app.command)}
                    title={app.name}
                  >
                    <i className={app.icon}></i>
                    <span className="app-name">{app.name}</span>
                  </button>
                ))}
              </div>
            )}
          </div>
        );
      }
    </script>
  </body>
</html>
